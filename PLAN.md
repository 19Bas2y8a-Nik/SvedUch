# План реализации SvedUch

Поэтапный порядок действий по реализации программы на основании PROJECT.md.

---

## Этап 1. Окружение и каркас проекта

1. Создать виртуальное окружение (venv) и активировать его.
2. Добавить зависимости: PyQt (PyQt5 или PyQt6), драйвер SQLite (встроен в Python), библиотека для Excel (openpyxl или xlsxwriter). Оформить `requirements.txt`.
3. Создать структуру каталогов при необходимости (например, отдельные модули под окна или виджеты).
4. Реализовать минимальный запуск приложения из `main.py` (главное окно с заголовком, без функциональных кнопок).

---

## Этап 2. Модуль базы данных (db.py)

1. Реализовать подключение к SQLite (путь к файлу БД — из аргумента или настроек).
2. Реализовать создание всех таблиц при инициализации (схема по DATABASE.md): forms, programs, recommendations, pupils, pupils_history, settings.
3. Реализовать базовые операции для справочников:
   - forms: чтение списка, добавление, при необходимости удаление/редактирование.
   - programs: то же.
   - recommendations: чтение списка (в т.ч. по специалисту), добавление.
4. Реализовать CRUD для pupils: вставка, обновление, выборка по id, по form_id, по program_id; запрос для агрегации (количество учеников по программе).
5. Реализовать операции для pupils_history: вставка записей при переводе в другую школу/окончании школы.
6. Реализовать чтение/запись настроек в таблице settings (get/set по ключу).
7. Закрытие соединения при выходе из приложения.

---

## Этап 3. Главное окно и окно «Таблицы»

1. В `main.py` оформить главное окно с тремя кнопками: «Таблицы», «Выборки», «Перевод».
2. Реализовать окно «Таблицы» с кнопками для открытия работы с каждой таблицей: Классы (forms), Программы (programs), Рекомендации (recommendations), Ученики (pupils), Архив (pupils_history), Настройки (settings).
3. Для каждой справочной таблицы (forms, programs, recommendations) реализовать простое окно/диалог: просмотр записей в таблице (QTableWidget или QTableView + модель), добавление новой записи, при необходимости редактирование и удаление.
4. Обеспечить загрузку данных из db.py и отображение в виджетах.

---

## Этап 4. Ввод сведений об ученике (форма и временная таблица)

1. Реализовать экран/вкладку ввода ученика по макету из п. 4.3 PROJECT.md:
   - 1-й ряд: Класс, Фамилия, Имя, Отчество, Дата рождения.
   - 2-й ряд: Дата заключения ПМПК, Номер заключения ПМПК, Номер приказа, Дата приказа.
   - 3-й ряд: Программа, Версия (заполняются из выбора программы).
2. Реализовать выбор класса: кнопка/значок у поля «Класс» → всплывающее меню со списком номеров из таблицы forms; выбор заполняет поле.
3. Реализовать выбор программы: кнопка/значок у поля «Программа» → меню из таблицы programs; выбор заполняет «Программа» и «Версия», сохранить в памяти id выбранной программы для записи в pupils.
4. Реализовать блок «Рекомендации специалистам»: пять кнопок с наименованиями специалистов (уникальные имена из recommendations), под каждой — поле отображения выбранных рекомендаций (через «;»). У каждого поля — кнопка/значок выбора: мультивыбор рекомендаций из списка для данного специалиста из recommendations; выбранные отображать через «;».
5. Хранить введённые данные в памяти (например, словарь или объект «текущий ученик»), отображать в виде временной таблицы (виджет таблицы в памяти, не запись в SQLite).
6. Кнопка «Сохранить»: вызвать db.py — вставка одной записи в pupils (form_id, program_id, рекомендации в rec_spec_1 … rec_spec_5); после успешной записи очистить форму и временную таблицу.

---

## Этап 5. Окно «Выборки»

1. Реализовать окно с критериями фильтрации: номер класса (выпадающий список из forms), программа (выпадающий список из programs). Возможность задать один критерий, оба или ни одного (тогда — все ученики).
2. По кнопке «Выполнить» / «Найти» формировать выборку из pupils через db.py; отображать результат во временной таблице (в памяти), без записи в SQLite.
3. Реализовать режим «Количество учеников по программе»: запрос агрегации по program_id (программа — количество); вывести результат во временной таблице.
4. Реализовать выбор отображаемых полей: все поля таблицы pupils или подмножество (чекбоксы или список полей).
5. Кнопка «Экспорт в Excel»: выгрузка текущей временной таблицы в файл .xlsx (openpyxl или аналог).
6. Кнопка «Очистить»: очистка результатов и сброс критериев при необходимости.

---

## Этап 6. Окно «Перевод»

1. Разделить окно на два блока: «Перевод ученика» и «Перевод класса».

**Блок «Перевод ученика»:**

2. Поля фильтра: Фамилия, Имя, Отчество, номер класса (из forms). По кнопке «Найти» — выборка из pupils во временную таблицу (в памяти).
3. Выбор одного ученика из списка (таблица или список с выбором одной строки).
4. Поля: дата перевода, причина перевода.
5. Выбор типа перевода: «В другую школу» (или «Окончание школы») / «В другой класс или на другую программу».
6. Кнопка «Сохранить»:
   - при «в другую школу»: скопировать запись в pupils_history (добавить transfer_date, transfer_reason), удалить запись из pupils;
   - при «другой класс/программа»: обновить в pupils класс (form_id) и/или программу (program_id) и при необходимости другие поля по смыслу; дату и причину перевода при необходимости сохранять только в интерфейсе или в отдельном учёте по требованию.

**Блок «Перевод класса»:**

7. Выбор номера класса (из forms). По кнопке — загрузка всех учеников этого класса во временную таблицу (в памяти). Возможность отметить одного, нескольких или всех учеников.
8. Поля: дата перевода, причина перевода. Кнопка «Сохранить».
9. Логика при «Сохранить»:
   - если класс 11-й (например, number начинается с «11» или по соглашению): для выбранных учеников перенести записи в pupils_history (добавить transfer_date, transfer_reason), удалить их из pupils;
   - для остальных классов: для выбранных учеников обновить в pupils номер класса (увеличить число на 1, букву оставить; например 5А → 6А), при необходимости записать дату/причину перевода в отдельное поле или только в интерфейсе.

10. Согласовать с PROJECT.md: для перевода класса в конце года «автоматизированно изменяется номер класса» — реализовать преобразование номера (число +1, буква та же) и обновление form_id (новый или существующий класс в forms).

---

## Этап 7. Настройки и завершение

1. При старте приложения загружать настройки из таблицы settings (путь к БД, геометрия окна, тема и т.д.).
2. При закрытии главного окна сохранять настройки (размер/положение окна и др.) в settings через db.py.
3. Обеспечить создание/подключение БД по пути из настроек или по умолчанию (например, в каталоге приложения).
4. Проверить все сценарии по PROJECT.md: ввод ученика, выборки (в т.ч. по количеству на программе), перевод ученика (два типа), перевод класса (11-й и не 11-й).
5. Удалить отладочный вывод, при необходимости добавить обработку ошибок и сообщения пользователю.

---

## Этап 8. Добавление новых полей (п. 8 PROJECT.md)

1. **Схема БД:** В таблицы Ученики (pupils) и Архив (pupils-history) добавить два поля:
   - **Домашний адрес** — между полями «Дата рождения» и «Дата заключения ПМПК»; ширина 50 символов.
   - **Пол** — рядом с домашним адресом; ширина 4 символа.
   Реализовать миграцию/обновление схемы в db.py (ALTER TABLE или пересоздание при инициализации) так, чтобы существующие БД получили новые колонки.

2. **Временные таблицы:** Во всех местах, где формируются временные таблицы по ученикам (ввод ученика, выборки, перевод), включить колонки «Домашний адрес» и «Пол» в том же порядке (после даты рождения, перед датой ПМПК).

3. **Вкладка «Добавить ученика» (раздел Таблицы → Ученики):** Добавить новый ряд полей между рядом «Класс, Фамилия, Имя, Отчество, Дата рождения» и рядом «Дата заключения ПМПК, …»: поля ввода «Домашний адрес» (до 50 символов) и «Пол» (до 4 символов). При сохранении записывать значения в pupils.

4. **Вкладка «Изменения по ученику» (раздел Таблицы → Ученики):** Добавить те же поля «Домашний адрес» и «Пол» в том же месте формы; при редактировании загружать и сохранять их в pupils.

5. **Окно «Выборки»:** В блоке «Отображаемые поля» добавить чекбоксы для полей «Домашний адрес» (подпись можно сократить до «Дом.адр.») и «Пол»; при формировании выборки включать эти колонки в результат, если отмечены.

6. **Перевод:** При переносе записи в pupils_history и при отображении данных в окне «Перевод» учитывать и передавать поля «Домашний адрес» и «Пол».

---

## Этап 9. Загрузка сведений из файла формата Excel (п. 9 PROJECT.md)

1. **Формат файла:** Файл Excel содержит таблицу с графами: Фамилия, Имя, Отчество, Дата рождения, Домашний адрес, Пол. При загрузке данные копируются в одноимённые поля таблицы Ученики (pupils).

2. **Место загрузки:** Реализовать во вкладке «Список учеников» раздела Таблицы → Ученики.

3. **Элементы интерфейса во вкладке «Список учеников»:**
   - Поле **Класс** — для ввода номера класса, к которому относятся загружаемые ученики. После загрузки значение класса автоматически проставляется в поле «номер класса» (form_id) по всем загруженным записям в pupils.
   - Рядом с полем Класс — окно для поиска и выбора файла Excel (виджет выбора файла) и кнопка **«Загрузить»**.

4. **Логика кнопки «Загрузить»:**
   - Прочитать выбранный файл Excel (openpyxl или аналог).
   - Сопоставить графы файла (Фамилия, Имя, Отчество, Дата рождения, Домашний адрес, Пол) с полями таблицы pupils.
   - Для каждой строки таблицы из файла: вставить запись в pupils с данными из граф и значением класса из поля «Класс» (form_id — получить или создать по номеру класса в forms).
   - Остальные поля записи pupils (дата ПМПК, номер заключения, приказ, программа, рекомендации и т.д.) при массовой загрузке оставить пустыми или значениями по умолчанию согласно схеме БД.

5. **Обработка ошибок:** При неверном формате файла, отсутствии ожидаемых граф или ошибке чтения выводить сообщение пользователю; при необходимости показывать номера строк, по которым произошла ошибка.

---

## Порядок выполнения (кратко)

| № | Этап |
|---|------|
| 1 | Окружение, зависимости, минимальный main.py |
| 2 | db.py: схема, CRUD справочников, pupils, pupils_history, settings |
| 3 | Главное окно, окно «Таблицы», просмотр/редактирование справочников |
| 4 | Форма ввода ученика, выбор класса/программы/рекомендаций, временная таблица, «Сохранить» |
| 5 | Окно «Выборки»: фильтры, агрегация по программе, экспорт в Excel, «Очистить» |
| 6 | Окно «Перевод»: перевод ученика (тип + сохранение), перевод класса (логика 11-й / смена номера) |
| 7 | Настройки, сохранение геометрии, финальная проверка |
| 8 | Добавление новых полей: Домашний адрес и Пол в pupils/pupils_history, форма ввода, выборки, перевод |
| 9 | Загрузка сведений из файла Excel во вкладке «Список учеников»: поле Класс, выбор файла, кнопка «Загрузить» |

Дальнейшие уточнения (например, точный формат номера класса для 11-го, хранение даты/причины при переводе «в другой класс») при необходимости зафиксировать в PROJECT.md или DATABASE.md.

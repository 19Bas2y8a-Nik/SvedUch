# Схема базы данных SvedUch

База данных: **SQLite**. Доступ инкапсулирован в модуле `db.py`.

---

## Таблицы

### 1. forms (классы)

Справочник классов школы. Номер класса может содержать цифры и буквы (например, 5А, 10Б).

| Поле   | Тип    | Ограничения        | Описание      |
|--------|--------|---------------------|---------------|
| id     | INTEGER| PRIMARY KEY AUTOINCREMENT | Суррогатный ключ |
| number | TEXT   | NOT NULL, UNIQUE    | Номер класса  |

---

### 2. programs (программы)

Справочник программ обучения.

| Поле    | Тип    | Ограничения        | Описание      |
|---------|--------|---------------------|---------------|
| id      | INTEGER| PRIMARY KEY AUTOINCREMENT | Суррогатный ключ |
| name    | TEXT   | NOT NULL            | Наименование программы |
| version | TEXT   | NOT NULL            | Версия программы |

---

### 3. recommendations (рекомендации специалистам)

Справочник рекомендаций. Одному специалисту может соответствовать несколько строк с разными рекомендациями.

| Поле                | Тип    | Ограничения | Описание                    |
|---------------------|--------|-------------|-----------------------------|
| id                  | INTEGER| PRIMARY KEY AUTOINCREMENT | Суррогатный ключ       |
| specialist_name     | TEXT   | NOT NULL    | Наименование специалиста    |
| recommendation_name | TEXT   | NOT NULL    | Наименование рекомендации  |

Уникальность пары (specialist_name, recommendation_name) целесообразна для избежания дубликатов.

---

### 4. pupils (ученики)

Основная таблица сведений об учениках.

| Поле         | Тип    | Ограничения | Описание |
|--------------|--------|-------------|----------|
| id           | INTEGER| PRIMARY KEY AUTOINCREMENT | Суррогатный ключ |
| form_id      | INTEGER| NOT NULL, FK → forms.id | Ссылка на класс |
| surname      | TEXT   | NOT NULL    | Фамилия |
| name         | TEXT   | NOT NULL    | Имя |
| patronymic   | TEXT   |             | Отчество |
| birth_date   | TEXT   |             | Дата рождения (ISO или локальный формат) |
| pmpk_date    | TEXT   |             | Дата заключения ПМПК |
| pmpk_number  | TEXT   |             | Номер заключения ПМПК |
| program_id   | INTEGER| FK → programs.id | Ссылка на программу (для выборок по программе и подсчёта учеников) |
| order_number | TEXT   |             | Номер приказа |
| order_date   | TEXT   |             | Дата приказа |
| rec_spec_1   | TEXT   |             | Рекомендации 1-му специалисту: через «;» или «нет» |
| rec_spec_2   | TEXT   |             | Рекомендации 2-му специалисту |
| rec_spec_3   | TEXT   |             | Рекомендации 3-му специалисту |
| rec_spec_4   | TEXT   |             | Рекомендации 4-му специалисту |
| rec_spec_5   | TEXT   |             | Рекомендации 5-му специалисту |

Порядок специалистов (1–5) задаётся уникальными именами из таблицы `recommendations` (например, по первому появлению в таблице или отдельному справочнику порядка). В интерфейсе подставляются наименования из `recommendations`.

---

### 5. pupils_history (архив)

Архивные записи при переводе в другую школу или окончании школы. Структура полей повторяет `pupils`, добавлены два поля.

| Поле            | Тип    | Ограничения | Описание |
|-----------------|--------|-------------|----------|
| id              | INTEGER| PRIMARY KEY AUTOINCREMENT | Суррогатный ключ |
| form_id         | INTEGER| NOT NULL    | Класс на момент перевода |
| surname         | TEXT   | NOT NULL    | Фамилия |
| name            | TEXT   | NOT NULL    | Имя |
| patronymic      | TEXT   |             | Отчество |
| birth_date      | TEXT   |             | Дата рождения |
| pmpk_date       | TEXT   |             | Дата заключения ПМПК |
| pmpk_number     | TEXT   |             | Номер заключения ПМПК |
| program_id      | INTEGER|             | Ссылка на программу |
| order_number    | TEXT   |             | Номер приказа |
| order_date      | TEXT   |             | Дата приказа |
| rec_spec_1 … rec_spec_5 | TEXT |       | Рекомендации по специалистам |
| transfer_date   | TEXT   | NOT NULL    | Дата перевода |
| transfer_reason | TEXT   |             | Причина перевода |

Внешние ключи на `forms.id` и `programs.id` можно не объявлять (архив исторический), но типы полей согласованы с `pupils`.

---

### 6. settings (настройки)

Хранение настроек приложения в формате «ключ — значение».

| Поле   | Тип  | Ограничения | Описание        |
|--------|------|-------------|-----------------|
| key    | TEXT | PRIMARY KEY | Имя параметра   |
| value  | TEXT |             | Значение параметра |

Примеры ключей: `db_path`, `theme`, `window_geometry`, `window_state`.

---

## Связи (ER)

- **pupils.form_id** → **forms.id** (ученик в одном классе)
- **pupils.program_id** → **programs.id** (ученик на одной программе)
- **pupils_history** — копия структуры pupils без объявления FK к актуальным справочникам

Таблица **recommendations** не связана с pupils внешним ключом: в pupils хранятся текстовые значения (списки через «;»), сформированные по справочнику recommendations.

---

## Индексы (рекомендуемые)

- `forms(number)` — уникальный (UNIQUE уже задаёт индекс)
- `programs(name, version)` — для отображения и выбора
- `pupils(form_id)` — выборки по классу
- `pupils(program_id)` — выборки и агрегация по программе (количество учеников на программе)
- `recommendations(specialist_name)` — выбор рекомендаций по специалисту

---

## Инициализация

При первом запуске или при отсутствии БД модуль `db.py` создаёт файл SQLite и выполняет `CREATE TABLE` для всех таблиц в указанном порядке (с учётом зависимостей: сначала forms, programs, recommendations, settings; затем pupils; затем pupils_history).
